---
- name: Back up configs to github
  hosts: cisco
  connection: network_cli
  gather_facts: no
  vars_files:
    - default_vars.yml

  tasks:
    - name: clone configuration archives to ansible control
      git:
        repo: 'https://github.com/michaelford85/ios-config-archives.git'
        dest: ./ios-config-archives
        clone: yes
        force: yes
      run_once: yes
      delegate_to: localhost

    - name: copy running configs to ios-config-archives
      command: cp -f ./running_config/{{inventory_hostname}}.cfg ./ios-config-archives
      delegate_to: localhost

    - name: retrieve timestamp
      shell: "date +%Y-%m-%d%H-%M-%S.%5N"
      register: tstamp_ns
      delegate_to: localhost
      run_once: yes

    - name: Set variables
      set_fact:
        cur_date: "{{ tstamp_ns.stdout[0:10]}}"
        cur_time: "{{ tstamp_ns.stdout[10:]}}"
        cur_time_ns: "{{ tstamp_ns.stdout[10:]}}"
      delegate_to: localhost
      run_once: yes

    - name: print playbook_dir
      debug:
        msg: "{{ playbook_dir }}"

    - name: set git username
      git_config:
        name: user.email
        scope: global
        value: "{{ git_username }}"
      run_once: yes
      delegate_to: localhost
      become: yes

    - name: set git name
      git_config:
        name: user.name
        scope: global
        value: "{{ git_name }}"
      run_once: yes
      delegate_to: localhost
      become: yes

    - name: set git password
      git_config:
        name: user.password
        scope: global
        value: "{{ git_password }}"
      run_once: yes
      delegate_to: localhost
      become: yes

    - name: set git origin
      git_config:
        name: remote.origin.url
        scope: global
        value: 'https://github.com/michaelford85/ios-config-archives.git'
      run_once: yes
      delegate_to: localhost
      become: yes

    - name: Push configurations to github
      shell: |
        cd {{ playbook_dir }}/ios-config-archives
        git add .
        git commit -m "Test configuration archive {{ cur_date }}"
        git push origin --force
      run_once: yes
      delegate_to: localhost
      become: yes


    - name: ensure ios-config-archives directory is absent
      file:
        path: ./ios-config-archives
        state: absent
      delegate_to: localhost
      run_once: yes

    - name: Push configurations to github
      shell: |
        git config --global --unset user.name
        git config --global --unset user.email
        git config --global --unset user.password
      run_once: yes
      delegate_to: localhost
